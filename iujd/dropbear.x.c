#if 0
	shc Version 4.0.1, Generic Shell Script Compiler
	GNU GPL Version 3 Md Jahidul Hamid <jahidulhamid@yahoo.com>

	shc -f dropbear 
#endif

static  char data [] = 
#define      tst1_z	22
#define      tst1	((&data[1]))
	"\177\232\232\103\024\056\302\001\015\020\241\007\324\057\070\345"
	"\103\175\254\122\067\210\061\212\022"
#define      rlax_z	1
#define      rlax	((&data[25]))
	"\232"
#define      date_z	1
#define      date	((&data[26]))
	"\370"
#define      opts_z	1
#define      opts	((&data[27]))
	"\044"
#define      chk1_z	22
#define      chk1	((&data[29]))
	"\341\254\347\145\027\173\060\347\135\040\217\153\234\264\033\135"
	"\346\075\123\331\212\306\343\077\206"
#define      chk2_z	19
#define      chk2	((&data[56]))
	"\064\025\224\346\133\204\244\127\274\347\357\104\220\234\254\106"
	"\336\231\110\040\304\147\057\071\010\105"
#define      text_z	2737
#define      text	((&data[284]))
	"\077\327\301\365\242\033\035\220\312\327\136\037\152\261\234\113"
	"\360\043\113\266\376\200\314\222\260\005\232\365\305\347\244\004"
	"\277\146\372\142\201\027\362\114\357\120\154\131\002\011\245\362"
	"\054\361\251\053\161\165\275\042\173\130\027\100\077\274\104\377"
	"\042\076\141\244\126\123\360\105\244\135\237\246\146\104\231\223"
	"\066\102\276\247\267\173\311\063\323\341\163\023\235\270\023\300"
	"\366\164\144\115\310\125\222\155\262\061\024\031\166\255\254\254"
	"\357\153\124\247\347\036\332\273\000\115\316\236\006\341\136\374"
	"\126\303\112\036\031\334\214\314\016\240\345\205\115\222\061\074"
	"\375\206\343\344\245\276\237\245\014\156\103\022\120\242\016\246"
	"\146\130\305\177\065\121\114\104\362\061\311\077\304\373\174\301"
	"\201\140\246\047\036\106\314\052\264\020\074\005\262\113\254\030"
	"\244\161\230\331\303\344\036\265\026\347\365\332\342\017\325\207"
	"\000\077\011\334\201\132\352\167\107\063\136\145\027\142\305\130"
	"\077\206\210\345\045\170\361\320\335\113\320\142\244\345\265\277"
	"\211\242\061\267\343\345\263\131\306\344\227\334\321\162\263\011"
	"\326\217\224\251\064\364\321\013\327\154\307\127\206\101\330\237"
	"\114\137\345\332\177\203\072\030\232\032\070\374\055\011\205\336"
	"\372\116\042\312\075\305\266\311\172\154\033\103\133\153\313\151"
	"\360\246\125\031\357\177\352\240\131\267\005\345\224\072\052\000"
	"\324\315\327\250\206\051\020\315\243\205\221\023\162\205\334\053"
	"\037\072\141\214\224\273\027\245\213\253\232\314\074\022\046\332"
	"\352\355\013\236\237\334\125\144\020\306\002\150\010\330\254\370"
	"\001\106\013\367\247\210\013\364\052\351\337\264\177\145\271\356"
	"\040\032\117\040\067\351\240\241\326\223\300\242\304\123\000\272"
	"\242\356\272\373\330\161\002\055\215\027\267\167\173\041\232\150"
	"\323\035\327\220\265\340\311\174\223\013\356\313\326\022\115\157"
	"\117\105\272\276\043\211\204\235\026\345\162\033\055\210\044\250"
	"\073\151\026\332\161\234\356\056\127\276\372\314\055\012\201\214"
	"\147\161\263\315\354\351\367\363\172\165\365\007\160\263\102\210"
	"\306\171\151\321\274\310\263\000\220\270\136\015\123\240\260\345"
	"\300\204\264\343\225\124\327\174\326\332\011\140\316\267\207\243"
	"\370\245\361\275\357\111\356\236\276\360\034\030\260\257\176\216"
	"\265\372\336\074\136\235\145\001\236\104\345\376\103\143\061\255"
	"\114\030\046\065\277\121\276\371\347\213\147\162\202\177\364\056"
	"\044\132\205\213\275\032\247\206\227\315\370\231\232\116\247\212"
	"\337\113\223\020\134\207\024\333\116\171\131\243\302\216\241\255"
	"\332\302\263\261\101\253\040\206\264\227\212\114\235\175\123\306"
	"\273\355\006\113\175\275\275\125\303\367\262\057\064\311\112\302"
	"\076\366\104\027\271\152\024\130\152\052\247\027\062\231\373\021"
	"\374\151\207\355\022\153\152\220\163\004\243\247\351\021\376\137"
	"\350\324\014\116\030\175\247\261\044\217\032\054\123\237\244\031"
	"\361\064\203\163\075\032\035\324\106\025\157\377\206\267\003\256"
	"\014\143\357\153\110\066\232\221\172\326\242\126\320\152\362\361"
	"\071\156\067\215\030\376\036\225\013\337\040\271\330\362\102\115"
	"\321\111\263\152\343\117\111\162\267\230\001\060\042\240\100\264"
	"\343\145\324\303\062\233\130\213\240\055\005\234\026\003\060\361"
	"\104\105\235\346\161\264\374\226\267\204\344\304\147\302\044\322"
	"\014\214\107\043\040\320\212\135\136\277\166\273\010\134\206\004"
	"\320\166\220\136\070\246\166\017\141\126\252\322\201\073\272\303"
	"\225\116\364\014\360\275\313\247\154\032\043\226\030\134\101\124"
	"\354\134\314\261\232\332\220\251\206\252\320\011\112\310\240\110"
	"\124\051\353\176\262\076\311\177\242\140\243\253\331\006\062\371"
	"\005\222\136\230\264\352\023\013\244\105\130\053\131\140\235\014"
	"\340\112\034\040\156\030\253\127\141\167\204\103\122\234\216\232"
	"\004\304\202\330\261\346\231\332\051\311\272\064\070\142\350\340"
	"\066\207\222\026\356\254\233\353\351\123\122\124\247\122\263\063"
	"\056\372\160\005\173\075\226\140\216\354\057\012\264\074\157\125"
	"\074\017\353\314\015\303\134\133\067\343\366\360\027\135\305\021"
	"\347\217\275\332\316\236\275\142\066\046\301\174\376\160\070\304"
	"\222\200\224\000\343\107\003\305\273\037\117\066\327\374\126\351"
	"\223\042\372\323\373\205\312\354\037\363\220\071\002\311\214\371"
	"\114\365\327\366\142\050\130\212\142\047\261\020\325\054\320\373"
	"\046\053\051\050\174\374\307\274\206\201\073\377\055\233\014\011"
	"\367\217\370\243\223\262\233\115\305\250\352\233\016\272\050\335"
	"\276\060\115\212\334\323\315\255\207\160\262\332\335\205\003\057"
	"\367\200\363\300\224\160\021\304\152\116\024\010\354\367\310\066"
	"\227\340\306\235\342\304\254\112\073\005\015\304\066\242\324\170"
	"\017\060\176\205\137\060\346\063\261\145\314\104\002\304\026\067"
	"\314\352\250\205\361\107\356\046\037\110\246\004\023\344\057\263"
	"\027\057\250\257\014\261\037\075\132\257\214\170\370\256\111\233"
	"\332\027\203\012\311\350\001\221\337\114\356\147\116\205\054\012"
	"\225\227\066\065\032\127\171\340\046\246\106\315\167\062\314\031"
	"\262\062\023\266\315\005\266\132\115\270\117\373\275\154\146\125"
	"\007\243\034\207\364\131\064\002\133\021\360\371\261\217\315\033"
	"\046\272\132\045\313\060\021\351\123\102\056\327\204\350\333\146"
	"\322\215\233\065\374\264\327\310\375\317\351\262\366\263\362\140"
	"\307\136\135\130\254\177\226\101\040\336\306\230\004\323\027\345"
	"\245\263\213\204\141\073\032\243\123\367\150\372\007\010\306\320"
	"\144\146\141\206\061\227\214\050\226\230\104\032\040\345\155\104"
	"\010\204\304\056\150\302\315\163\166\231\057\157\120\003\375\246"
	"\166\367\240\107\253\007\014\110\056\173\303\261\017\103\145\252"
	"\151\211\233\371\040\365\312\147\011\237\046\360\253\337\337\240"
	"\334\162\107\025\363\261\022\331\340\141\171\231\353\061\253\110"
	"\254\373\322\030\360\161\003\335\235\116\135\004\307\310\346\176"
	"\254\167\377\300\216\335\374\162\005\162\202\064\277\210\146\062"
	"\115\216\110\030\302\332\145\204\037\212\032\373\054\265\163\077"
	"\351\110\020\253\332\247\374\310\344\257\137\231\142\272\206\317"
	"\336\214\014\337\360\265\211\307\046\301\011\305\251\373\076\061"
	"\203\076\162\017\204\206\327\235\037\002\346\227\177\340\213\157"
	"\053\216\166\051\125\111\344\126\124\014\156\107\272\333\025\132"
	"\236\036\351\201\167\143\325\003\020\201\030\242\157\335\310\221"
	"\170\147\007\240\205\016\204\076\231\051\325\243\326\066\276\260"
	"\352\363\367\020\040\175\060\242\153\024\213\046\120\234\356\162"
	"\072\152\252\360\173\364\072\060\154\025\346\206\234\011\264\125"
	"\265\134\143\060\241\071\075\041\002\350\275\122\063\056\137\065"
	"\316\116\362\147\011\263\010\130\010\006\133\020\336\020\215\233"
	"\343\132\374\056\327\166\146\211\364\341\214\041\366\266\314\301"
	"\056\113\266\127\270\002\354\150\216\256\123\361\256\062\302\325"
	"\300\365\262\035\267\302\153\232\163\236\044\174\142\052\323\351"
	"\235\277\304\343\237\336\017\143\232\127\005\164\374\252\120\113"
	"\237\371\251\225\267\166\323\241\153\276\072\264\311\054\040\277"
	"\307\347\243\175\163\324\337\134\002\366\150\251\360\357\343\312"
	"\312\240\004\201\060\274\012\044\032\127\015\063\237\200\006\033"
	"\367\023\012\225\064\152\373\321\325\337\074\060\157\114\117\146"
	"\350\154\036\143\115\202\133\157\210\350\075\215\366\361\037\074"
	"\123\163\176\173\067\133\170\305\055\323\263\047\075\262\172\313"
	"\271\114\050\211\344\215\366\275\003\317\166\211\101\135\071\136"
	"\036\000\047\212\273\346\241\243\362\070\210\023\047\231\372\365"
	"\330\136\344\265\132\274\136\173\036\344\131\020\005\031\241\313"
	"\231\054\151\221\241\251\226\173\003\043\120\134\036\023\221\316"
	"\023\306\035\277\053\336\165\051\154\066\342\301\312\046\120\172"
	"\024\276\162\043\004\246\046\051\005\355\256\163\074\164\101\016"
	"\003\225\132\323\330\016\023\316\006\167\174\022\370\101\007\043"
	"\244\245\275\146\237\240\313\143\356\147\051\203\257\061\017\134"
	"\217\233\330\261\371\163\365\012\006\240\034\125\317\126\334\277"
	"\300\012\001\355\104\122\246\320\235\115\272\033\016\130\261\163"
	"\332\362\051\117\145\141\136\042\173\174\153\234\373\212\304\236"
	"\251\116\034\353\112\337\044\266\203\240\266\323\332\001\106\320"
	"\354\110\152\345\370\205\056\243\155\250\003\144\114\314\234\303"
	"\123\304\132\245\115\247\016\160\004\151\170\255\301\066\054\050"
	"\325\152\114\045\073\245\053\227\261\175\362\345\202\240\077\106"
	"\322\167\275\262\314\231\001\053\142\345\344\303\330\307\020\047"
	"\101\240\116\341\331\235\061\212\152\033\250\275\004\146\356\335"
	"\177\316\371\330\260\333\273\046\106\140\022\247\300\344\365\331"
	"\203\012\253\227\320\355\255\245\374\242\272\376\024\025\307\111"
	"\124\361\115\132\121\330\332\351\226\144\133\166\013\326\107\151"
	"\336\363\127\372\000\204\150\207\133\135\350\323\163\011\277\132"
	"\247\306\151\362\056\050\317\013\310\346\100\315\361\333\271\160"
	"\054\124\006\337\274\177\320\141\214\270\300\070\034\161\025\013"
	"\020\146\360\017\213\330\010\155\002\206\106\055\270\142\341\156"
	"\254\303\077\120\115\312\035\262\267\031\300\230\172\333\207\350"
	"\100\317\243\024\155\341\120\050\266\157\212\347\145\024\333\335"
	"\167\310\111\250\342\214\155\305\032\215\362\251\051\072\116\257"
	"\127\377\047\113\302\207\003\176\232\021\264\045\254\216\374\001"
	"\040\350\360\167\146\213\243\231\361\246\356\255\010\001\227\061"
	"\135\256\034\143\237\047\311\105\160\146\232\205\237\334\042\312"
	"\327\175\073\062\375\043\122\055\305\212\204\124\255\157\033\070"
	"\334\342\116\300\210\051\111\150\113\356\221\227\325\150\307\146"
	"\165\277\313\242\271\243\306\273\360\320\257\377\011\074\306\156"
	"\115\175\230\275\156\023\034\054\344\226\047\236\004\345\263\172"
	"\271\040\022\051\031\005\066\311\133\100\361\110\362\266\311\365"
	"\166\353\042\013\330\257\362\153\351\045\045\170\324\173\104\355"
	"\363\042\076\116\135\055\241\206\334\376\334\053\223\277\321\070"
	"\044\232\225\140\346\002\117\256\061\066\327\072\312\201\037\123"
	"\221\107\154\066\055\343\361\327\206\121\006\231\334\273\312\127"
	"\230\306\162\004\305\207\240\107\360\117\244\203\344\134\254\360"
	"\351\344\143\320\320\315\055\001\047\276\324\163\216\232\000\312"
	"\100\277\241\010\162\126\105\343\236\326\206\150\301\315\207\271"
	"\136\165\341\177\225\301\376\240\072\260\123\047\352\171\267\321"
	"\356\347\046\362\313\231\026\022\104\017\134\331\007\127\251\337"
	"\304\067\265\157\226\256\213\230\061\352\207\071\366\064\250\227"
	"\342\342\344\076\043\036\264\206\146\016\321\142\220\356\110\355"
	"\122\277\273\264\016\027\224\022\310\107\137\355\104\362\021\102"
	"\221\362\327\102\200\007\376\256\317\231\032\147\266\022\371\374"
	"\235\265\110\065\262\311\152\326\032\056\334\202\365\051\275\144"
	"\252\232\214\151\152\125\161\042\142\272\135\117\205\201\057\136"
	"\052\144\103\255\321\350\104\365\053\353\277\002\133\311\057\317"
	"\347\202\000\260\115\350\355\125\016\205\000\152\274\011\242\036"
	"\034\004\146\306\261\206\241\176\012\345\375\155\170\011\234\344"
	"\172\042\245\013\305\106\237\231\174\257\275\150\074\046\333\300"
	"\310\032\011\134\143\212\362\262\270\061\363\327\153\372\377\263"
	"\302\274\230\105\147\264\133\052\141\112\050\242\017\250\256\240"
	"\063\363\310\225\055\127\351\246\260\225\100\152\134\271\375\040"
	"\247\254\267\002\127\017\310\037\211\117\045\016\204\314\006\273"
	"\314\312\263\363\001\022\076\115\364\031\142\112\174\104\037\155"
	"\205\036\362\013\341\037\202\156\004\071\054\275\042\320\307\033"
	"\061\305\377\112\136\037\331\154\376\367\362\140\251\043\161\121"
	"\301\373\146\165\250\352\161\127\044\364\136\337\325\377\040\037"
	"\140\243\106\151\172\256\316\011\154\253\230\053\206\307\117\257"
	"\225\106\226\037\115\176\352\037\147\317\330\026\014\325\112\057"
	"\015\051\011\244\372\175\235\164\360\316\170\026\347\035\336\340"
	"\302\053\145\210\222\374\107\103\033\204\316\104\050\053\213\045"
	"\214\066\144\237\150\113\064\314\374\030\354\307\027\263\274\346"
	"\060\300\014\275\204\110\075\203\270\350\314\265\147\153\155\175"
	"\127\140\152\313\020\051\056\045\366\317\027\274\312\177\176\276"
	"\016\327\076\137\221\076\221\034\270\014\204\144\131\307\304\176"
	"\204\030\033\147\316\344\024\141\240\335\055\310\100\161\352\220"
	"\121\040\226\072\274\071\347\000\323\063\173\122\017\230\174\163"
	"\142\201\124\163\106\313\346\106\347\035\302\165\274\132\054\353"
	"\027\056\061\150\076\243\127\247\163\231\304\124\053\167\043\055"
	"\016\341\322\060\007\076\102\366\365\054\013\375\036\023\041\346"
	"\122\131\260\114\054\020\127\354\011\362\046\106\126\374\327\052"
	"\134\324\071\263\030\204\207\240\134\111\207\251\353\240\162\234"
	"\144\322\103\213\360\211\130\033\076\150\127\104\032\243\360\063"
	"\107\142\314\041\045\261\077\333\310\047\321\243\011\103\077\156"
	"\025\203\371\006\015\121\042\114\271\171\220\324\035\200\010\145"
	"\343\324\206\011\206\306\344\116\355\266\361\367\371\061\145\017"
	"\264\137\026\302\261\070\016\153\262\236\100\317\037\110\064\003"
	"\035\273\014\243\202\361\361\160\247\342\147\241\023\315\260\310"
	"\055\306\212\337\376\230\112\261\067\212\200\127\323\265\133\360"
	"\160\147\223\362\130\204\143\377\147\312\240\172\230\121\103\306"
	"\030\315\245\027\146\360\310\236\172\110\366\115\375\121\076\156"
	"\270\321\141\021\126\304\021\275\217\262\070\050\003\173\356\034"
	"\111\223\063\257\203\373\116\376\104\105\114\102\226\212\261\117"
	"\134\022\141\262\327\162\157\146\045\250\216\050\043\175\105\154"
	"\021\170\034\225\164\153\224\270\260\340\373\107\153\254\227\310"
	"\276\370\172\225\153\352\374\220\222\213\271\266\010\376\042\032"
	"\167\077\257\353\252\103\244\132\044\237\242\217\114\071\130\012"
	"\062\322\240\236\275\235\056\120\050\350\007\061\347\052\113\136"
	"\151\372\112\024\076\357\157\142\216\021\362\332\113\112\345\175"
	"\035\206\033\333\044\112\054\115\063\063\176\032\135\312\171\306"
	"\305\303\333\003\262\112\146\101\133\130\034\246\243\002\044\300"
	"\211\077\234\255\212\310\373\275\373\171\330\131\104\121\040\011"
	"\025\373\014\307\105\163\011\240\313\046\107\157\050\153\057\262"
	"\253\314\140\065\224\133\363\220\325\313\352\031\034\012\042\061"
	"\006\057\371\113\242\003\354\156\051\063\335\122\237\015\005\112"
	"\331\145\200\156\301\163\377\226\076\351\257\133\364\322\215\372"
	"\002\207\106\244\213\062\023\264\146\360\007\005\375\014\117\327"
	"\162\317\106\063\103\105\312\202\057\172\335\043\114\153\036\116"
	"\363\144\363\176\227\006\063\375\367\072\002\365\107\122\314\272"
	"\041\022\356\144\130\270\346\207\063\304\253\177\060\312\316\043"
	"\056\302\242\305\310\325\303\300\020\305\265\127\027\202\022\071"
	"\224\000\236"
#define      tst2_z	19
#define      tst2	((&data[3493]))
	"\165\354\112\124\277\220\017\047\303\244\275\241\345\360\361\131"
	"\027\260\144\241\347\133\040\154"
#define      msg2_z	19
#define      msg2	((&data[3518]))
	"\236\031\375\100\207\357\231\020\023\177\027\347\273\211\242\176"
	"\236\100\323\204\160\016\363\337"
#define      pswd_z	256
#define      pswd	((&data[3543]))
	"\206\046\150\074\176\024\256\231\224\034\266\145\161\364\033\307"
	"\312\356\057\072\111\220\143\034\264\320\036\361\260\304\352\264"
	"\357\343\144\276\370\022\130\214\057\016\361\240\003\015\150\315"
	"\374\227\007\105\050\153\142\335\073\200\317\354\105\271\241\064"
	"\234\005\363\225\030\113\041\107\132\023\350\136\041\120\053\035"
	"\350\063\143\021\236\305\356\332\106\275\306\213\166\150\300\023"
	"\155\264\250\206\000\312\316\133\335\266\271\376\007\345\034\360"
	"\030\177\001\267\105\357\222\213\255\131\027\043\301\327\066\056"
	"\214\337\265\214\251\203\347\206\072\240\205\101\206\241\062\236"
	"\041\063\126\146\043\350\362\320\101\011\363\003\340\052\062\155"
	"\011\347\371\263\152\340\071\244\201\277\346\007\141\030\246\202"
	"\114\375\351\157\345\333\100\047\344\064\053\305\136\135\062\150"
	"\105\054\033\257\014\125\124\216\024\072\226\166\123\075\371\237"
	"\072\342\016\040\276\116\110\242\202\163\150\341\321\233\112\026"
	"\307\145\305\324\272\032\143\317\124\371\106\250\066\077\107\161"
	"\042\126\221\340\245\331\203\050\115\354\011\036\207\123\065\117"
	"\271\372\043\164\025\200\276\220\271\123\221\130\100\113\336\266"
	"\070\050\326\245\243\301\340\102\333\336\203\272\244\231\135\053"
	"\300\305\147\076\105\046\317\377\171\141\130\272\254\066"
#define      lsto_z	1
#define      lsto	((&data[3840]))
	"\327"
#define      inlo_z	3
#define      inlo	((&data[3841]))
	"\354\175\261"
#define      msg1_z	65
#define      msg1	((&data[3851]))
	"\344\111\310\237\355\142\374\145\015\240\115\373\342\307\226\234"
	"\247\215\345\351\377\127\165\126\365\140\236\223\213\022\070\045"
	"\330\230\140\033\024\041\031\224\074\344\150\102\177\036\237\346"
	"\363\024\357\336\142\164\201\315\016\017\137\247\171\300\303\350"
	"\127\020\101\352\050\212\270\104\031\042\302\201"
#define      xecc_z	15
#define      xecc	((&data[3920]))
	"\144\350\315\143\302\126\124\177\324\147\237\017\220\045\012\060"
	"\010"
#define      shll_z	10
#define      shll	((&data[3938]))
	"\333\371\170\031\304\212\342\133\135\217\074\076"/* End of data[] */;
#define      hide_z	4096
#define SETUID 0	/* Define as 1 to call setuid(0) at start of script */
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	1	/* Define as 1 to enable ptrace the executable */
#define HARDENING	0	/* Define as 1 to disable ptrace/dump the executable */
#define HARDENINGSP	0	/* Define as 1 to disable bash child process */
#define BUSYBOXON	0	/* Define as 1 to enable work with busybox */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

#if HARDENING

#include <sys/ptrace.h>
#include <sys/wait.h>
#include <signal.h>
#include <sys/prctl.h>
#define PR_SET_PTRACER 0x59616d61

/* Seccomp Sandboxing Init */
#include <stdlib.h>
#include <stdio.h>
#include <stddef.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>

#include <sys/types.h>
#include <sys/prctl.h>
#include <sys/syscall.h>
#include <sys/socket.h>

#include <linux/filter.h>
#include <linux/seccomp.h>
#include <linux/audit.h>

#define ArchField offsetof(struct seccomp_data, arch)

#define Allow(syscall) \
    BPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, SYS_##syscall, 0, 1), \
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW)

struct sock_filter filter[] = {
    /* validate arch */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, ArchField),
    BPF_JUMP( BPF_JMP+BPF_JEQ+BPF_K, AUDIT_ARCH_X86_64, 1, 0),
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),

    /* load syscall */
    BPF_STMT(BPF_LD+BPF_W+BPF_ABS, offsetof(struct seccomp_data, nr)),

    /* list of allowed syscalls */
    Allow(exit_group),  /* exits a processs */
    Allow(brk),         /* for malloc(), inside libc */
    Allow(mmap),        /* also for malloc() */
    Allow(munmap),      /* for free(), inside libc */

    /* and if we don't match above, die */
    BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),
};
struct sock_fprog filterprog = {
    .len = sizeof(filter)/sizeof(filter[0]),
    .filter = filter
};

/* Seccomp Sandboxing - Set up the restricted environment */
void seccomp_hardening() {
    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {
        perror("Could not start seccomp:");
        exit(1);
    }
    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &filterprog) == -1) {
        perror("Could not start seccomp:");
        exit(1);
    }
} 
/* End Seccomp Sandboxing Init */

void arc4_hardrun(void * str, int len) {
    //Decode locally
    char tmp2[len];
    memcpy(tmp2, str, len);

	unsigned char tmp, * ptr = (unsigned char *)tmp2;

    int lentmp = len;

#if HARDENINGSP
    //Start tracing to protect from dump & trace
    if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }

    //Decode Bash
    while (len > 0) {
        indx++;
        tmp = stte[indx];
        jndx += tmp;
        stte[indx] = stte[jndx];
        stte[jndx] = tmp;
        tmp += stte[indx];
        *ptr ^= stte[tmp];
        ptr++;
        len--;
    }

    //Exec bash script
    system(tmp2);

    //Empty script variable
    memcpy(tmp2, str, lentmp);

    //Sinal to detach ptrace
    ptrace(PTRACE_DETACH, 0, 0, 0);
    exit(0);

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
#endif /* HARDENINGSP Exit here anyway*/

    int pid, status;
    pid = fork();

    if(pid==0) {

        //Start tracing to protect from dump & trace
        if (ptrace(PTRACE_TRACEME, 0, 0, 0) < 0) {
            printf("Operation not permitted\n");
            kill(getpid(), SIGKILL);
            _exit(1);
        }

        //Decode Bash
        while (len > 0) {
            indx++;
            tmp = stte[indx];
            jndx += tmp;
            stte[indx] = stte[jndx];
            stte[jndx] = tmp;
            tmp += stte[indx];
            *ptr ^= stte[tmp];
            ptr++;
            len--;
        }

        //Exec bash script
        system(tmp2);

        //Empty script variable
        memcpy(tmp2, str, lentmp);

        //Sinal to detach ptrace
        ptrace(PTRACE_DETACH, 0, 0, 0);
        exit(0);
    }
    else {
        wait(&status);
    }

    /* Seccomp Sandboxing - Start */
    seccomp_hardening();

    exit(0);
} 
#endif /* HARDENING */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

void chkenv_end(void);

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask = (unsigned long)getpid();
	stte_0();
	 key(&chkenv, (void*)&chkenv_end - (void*)&chkenv);
	 key(&data, sizeof(data));
	 key(&mask, sizeof(mask));
	arc4(&mask, sizeof(mask));
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

void chkenv_end(void){}

#if HARDENING

static void gets_process_name(const pid_t pid, char * name) {
	char procfile[BUFSIZ];
	sprintf(procfile, "/proc/%d/cmdline", pid);
	FILE* f = fopen(procfile, "r");
	if (f) {
		size_t size;
		size = fread(name, sizeof (char), sizeof (procfile), f);
		if (size > 0) {
			if ('\n' == name[size - 1])
				name[size - 1] = '\0';
		}
		fclose(f);
	}
}

void hardening() {
    prctl(PR_SET_DUMPABLE, 0);
    prctl(PR_SET_PTRACER, -1);

    int pid = getppid();
    char name[256] = {0};
    gets_process_name(pid, name);

    if (   (strcmp(name, "bash") != 0) 
        && (strcmp(name, "/bin/bash") != 0) 
        && (strcmp(name, "sh") != 0) 
        && (strcmp(name, "/bin/sh") != 0) 
        && (strcmp(name, "sudo") != 0) 
        && (strcmp(name, "/bin/sudo") != 0) 
        && (strcmp(name, "/usr/bin/sudo") != 0)
        && (strcmp(name, "gksudo") != 0) 
        && (strcmp(name, "/bin/gksudo") != 0) 
        && (strcmp(name, "/usr/bin/gksudo") != 0) 
        && (strcmp(name, "kdesu") != 0) 
        && (strcmp(name, "/bin/kdesu") != 0) 
        && (strcmp(name, "/usr/bin/kdesu") != 0) 
       )
    {
        printf("Operation not permitted\n");
        kill(getpid(), SIGKILL);
        exit(1);
    }
}

#endif /* HARDENING */

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PT_ATTACHEXC) /* New replacement for PT_ATTACH */
   #if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
       #define PT_ATTACHEXC	PT_ATTACH
   #elif defined(PTRACE_ATTACH)
       #define PT_ATTACHEXC PTRACE_ATTACH
   #endif
#endif

void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PT_ATTACHEXC, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];
	if (me == NULL) { me = getenv("_"); }
	if (me == 0) { fprintf(stderr, "E: neither argv[0] nor $_ works."); exit(1); }

	ret = chkenv(argc);
	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
#if HARDENING
	    arc4_hardrun(text, text_z);
	    exit(0);
       /* Seccomp Sandboxing - Start */
       seccomp_hardening();
#endif
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
#if BUSYBOXON
	varg[j++] = "busybox";
	varg[j++] = "sh";
#else
	varg[j++] = argv[0];		/* My own name at execution */
#endif
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if SETUID
   setuid(0);
#endif
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if HARDENING
	hardening();
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
